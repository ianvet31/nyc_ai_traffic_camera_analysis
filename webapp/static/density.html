<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NYC Traffic Camera Analysis - Traffic Density</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
    <div class="sidebar" id="sidebar">
        <div class="filter-group">
            <b>Filter Boroughs:</b>
            <label><input type="checkbox" class="borough-filter" value="Manhattan" checked> Manhattan</label>
            <label><input type="checkbox" class="borough-filter" value="Brooklyn"> Brooklyn</label>
            <label><input type="checkbox" class="borough-filter" value="Queens"> Queens</label>
            <label><input type="checkbox" class="borough-filter" value="Bronx"> Bronx</label>
            <label><input type="checkbox" class="borough-filter" value="Staten Island"> Staten Island</label>
        </div>
        <a href="/live" class="btn" id="liveBtn">Live Cameras</a>
        <button id="densityBtn" class="btn active">Traffic Density</button>
        <a href="/tracker" class="btn" id="trackerBtn">Tracker Mode</a>
    </div>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
    <script src="/static/js/common.js"></script>
    <script>
    let map, cameras, heatLayer = null;
    let trafficCounts = {};
    fetch('/static/cameras.json')
      .then(res => res.json())
      .then(data => {
        cameras = data;
        map = initBaseMap();
        function showDensityView() {
            const selectedBoroughs = getSelectedBoroughs();
            const heatData = [];
            for (const cam of cameras) {
                if (!selectedBoroughs.includes(cam.area)) continue;
                const tc = trafficCounts[cam.id];
                const density = tc ? (tc.cars + tc.people) : 0;
                if (density > 0) heatData.push([cam.latitude, cam.longitude, density]);
            }
            if (heatLayer) map.removeLayer(heatLayer);
            if (heatData.length > 0) {
                heatLayer = L.heatLayer(heatData, {radius: 25, blur: 15, maxZoom: 17}).addTo(map);
            } else {
                let sample = cameras.filter(cam => selectedBoroughs.includes(cam.area)).slice(0, 20);
                sample.forEach(cam => {
                    if (!trafficCounts[cam.id]) {
                        fetch('http://localhost:8000/detect_counts', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({image_url: cam.imageUrl, threshold: 0.3})
                        })
                        .then(res => res.json())
                        .then(data => {
                            if (data.traffic_assessment) {
                                trafficCounts[cam.id] = data.traffic_assessment;
                                showDensityView();
                            }
                        });
                    }
                });
            }
        }
        showDensityView();
    wireBoroughFilters(showDensityView);
    // If any markers/popups are added later, ensure popups are draggable
    map.on('popupopen', (e) => { if (e && e.popup) makePopupDraggable(e.popup); });
      });
    </script>
</body>
</html>
